YUI.add("yg-topic-base",function(a){a.Groups.TopicBase=function(){};a.Groups.TopicBase.prototype.initConfig=function(){var b=this,c;if(this.get("subtype")=="post"&&b.node.one("#post-comments-cont .yg-msg-read-container")){b.nodes=b.node.one("#post-comments-cont").all(".yg-msg-read-container")}else{b.nodes=b.node.all(".yg-msg-read-container")}b.nodesNumber=b.nodes.size();b.topicFolded=true;if(b.nodesNumber<=b.defaultNumMsgs){b.topicFolded=false}c=b.node.one(".msg-list-container");b.msgCount=c.getData("msgCount");b.reversePivot=b.topPivot=b.nodesNumber-2;b.msgOrder=true;b.maxResultsCount=30;if(b.nodesNumber>0){b.showThreadedView()}};a.Groups.TopicBase.prototype.keyHandler=function(b){if(b.keyCode==13){b.currentTarget.simulate("click")}};a.Groups.TopicBase.prototype.showThreadedView=function(){var f=this.nodesNumber,d=this.nodes,c=this,g,e;d.removeClass("hide");this.fetchMsg=false;if(!(GROUPS.PAGE._isMobile)){d.item(0).one(".cur-msg").replaceClass("hide","vis");if(this.nodesNumber>1){d.item(f-1).one(".cur-msg").replaceClass("hide","vis")}}else{if(GROUPS.PAGE._isMobile){d.item(0).one(".tm").addClass("tm-position");if(this.nodesNumber>1){d.item(f-1).one(".tm").addClass("tm-position")}}}if(f<=this.defaultNumMsgs&&this.msgCount<=this.defaultNumMsgs){d.addClass("card")}else{d.item(0).addClass("card");var b="STR_MORE_MESSAGE";if(this.get("subtype")=="post"){b="STR_MORE_COMMENT"}g=a.Node.create('<li class="msg-more-icon"><p><span class="expand-top"><i class="yg-sprite"></i></span>'+a.Handlebars.compile("{{#yrb}}"+b+"|{{num}}{{/yrb}}")({num:(c.msgCount-2)})+'<span class="expand-bottom"><i class="yg-sprite"></i></span></p></li>');d.item(0).insert(g,"after");for(e=1;e<f-1;e++){d.item(e).removeClass("card");d.item(e).addClass("hide");if(GROUPS.PAGE._isMobile){if(e==1){d.item(e).addClass("card-no-top-border")}d.item(e).addClass("card-height");d.item(e).one(".summary").addClass("summary-txt-position");d.item(e).one(".cur-msg").addClass("hide")}}d.item(f-2).addClass("card-border-bottom");if(GROUPS.PAGE._isMobile){d.item(f-2).addClass("card-height")}d.item(f-1).addClass("card card-border-bottom");window.scrollTo(0,GROUPS.PAGE.dockPos)}d.each(function(i,h){if(i.hasClass("card")&&i){if(i.getAttribute("data-attachments")==="1"){i.setAttribute("data-attach-displayed","1");new a.Groups.MessageAttachments({viewType:"fullView",groupName:c.get("groupName"),messageId:i.getAttribute("data-msgid"),container:i})}if(i.getData("poll")=="1"){a.use("yg-message-read-poll",function(j){i.setData("poll-attached","1");new j.Groups.MessageReadPoll({groupName:c.get("groupName"),container:i})})}}})};a.Groups.TopicBase.prototype._msgHeaderClickHandler=function(f){var l=this,g=f.currentTarget,i=g.ancestor(".yg-msg-read-container"),c,d,h=i.one(".summary"),j=i.one(".cur-msg"),k=i.one(".tm"),b=i.one(".show-post-full");if(g.hasClass("new-tab")){f.stopPropagation();f.preventDefault();window.open(g.get("href"),"_blank");return}d=i.next();c=i.previous();if(i.hasClass("card")){i.removeClass("card");i.one(".cur-msg").addClass("hide");if(GROUPS.PAGE._isMobile){i.addClass("card-height");h.addClass("summary-txt-position");j.addClass("hide");k.removeClass("tm-position")}GROUPS.INSTR.beaconClick("yg-iframe-container","topic-card-collapse",1,false)}else{i.addClass("card");if(GROUPS.PAGE._isMobile){i.removeClass("card-height");h.removeClass("summary-txt-position");j.removeClass("hide");k.addClass("tm-position")}GROUPS.INSTR.beaconClick("yg-iframe-container","topic-card-expand",1,false)}if(i.getAttribute("data-attachments")==="1"&&i.getAttribute("data-attach-displayed")!=="1"){new a.Groups.MessageAttachments({viewType:"fullView",groupName:l.get("groupName"),messageId:i.getAttribute("data-msgid"),container:i});i.setAttribute("data-attach-displayed","1")}if(i.getData("poll")=="1"&&i.getData("poll-attached")!="1"){a.use("yg-message-read-poll",function(e){i.setData("poll-attached","1");new e.Groups.MessageReadPoll({groupName:l.get("groupName"),container:i})})}if(b){b.toggleClass("hide")}if(typeof l.updateFoldBttn=="function"){l.updateFoldBttn()}};a.Groups.TopicBase.prototype._moreIconClickHandler=function(g){var i,c=g.currentTarget,f,d,h=true,b=this.msgCount-this.nodesNumber;if(c.hasClass("expand-top")){h=true;i=8}else{if(c.hasClass("expand-bottom")){h=false;i=9}else{return}}if(this.get("subtype")=="post"){this.nodes.replaceClass("hide","card")}else{this.nodes.removeClass("hide")}f=c.ancestor(".msg-more-icon");f.remove();GROUPS.INSTR.beaconClick("yg-iframe-container","topic-more",i,false);if(this.msgCount>this.nodesNumber){if(h){if(this.fetchMsg){if(this.msgOrder){d=this.nodes.item(this.topPivot).getData("next-msgid")}else{d=this.nodes.item(this.reversePivot).getData("prev-msgid");h=false}}else{this.fetchMsg=true;this.renderMoreIcon();GROUPS.INSTR.firePageBeacon("topic-more");GROUPS.PAGE.showAds(true,false);return}}else{if(this.msgOrder){d=this.nodes.item(this.topPivot+1).getData("prev-msgid")}else{d=this.nodes.item(this.reversePivot+1).getData("next-msgid");h=true}}this.getNextPage(d,h);return}GROUPS.INSTR.firePageBeacon("topic-more");GROUPS.PAGE.showAds(true,false)};a.Groups.TopicBase.prototype.getNextPage=function(e,f){var d=GROUPS.TOPICS_URL_TEMPLATE.replace("%groupName%",this.get("groupName"))+"/"+e,c=this,b=this.msgOrder?this.topPivot:this.reversePivot;itemsLeft=c.msgCount-c.nodesNumber,order=(f)?"true":"false";offset=(f)?(c.topPivot+1):(itemsLeft+c.topPivot+1),maxResults=(itemsLeft<c.maxResultsCount)?itemsLeft:c.maxResultsCount,query="isPaginated=true&noImage=true&noNavbar=true&maxResults="+maxResults+"&ascOrder="+order+"&offset="+offset,loader=a.Node.create('<li class="more-msg-loader fc-gray"><p>'+GROUPS.YRB_STRINGS.STR_LOADING_MESSAGE+"</p></li>"),this.fetchMsg=true;c.nodes.item(b).insert(loader,"after");GROUPS.DETAIL_IO.makeRequest(d,"GET",query,function(i,h){var g;loader.remove(true);if(i!==""){i=a.Node.create(i);i=i.all(".yg-msg-read-container");g=i.size();c.initCards(i);if(c.msgOrder){c.nodes.item(b).insert(i,"after")}else{c.nodes.item(b).insert(i._nodes.reverse(),"after")}i.item(g-1).addClass("card-border-bottom");c.nodes=c.node.all(".yg-msg-read-container");c.nodesNumber=c.nodes.size();if(f){c.topPivot=c.topPivot+g}else{c.reversePivot=c.reversePivot+g}if(c.msgCount>c.nodesNumber){c.renderMoreIcon()}}})};a.Groups.TopicBase.prototype.renderMoreIcon=function(e){var g=this.msgCount-this.nodesNumber,d,b=this.msgOrder?this.topPivot:this.reversePivot,f;if(!e){var c="STR_MORE_MESSAGE";if(this.get("subtype")=="post"){c="STR_MORE_COMMENT"}f=a.Node.create('<li class="msg-more-icon"><p><span class="expand-top"><i class="yg-sprite"></i></span>'+a.Handlebars.compile("{{#yrb}}"+c+"|{{num}}{{/yrb}}")({num:g})+'<span class="expand-bottom"><i class="yg-sprite"></i></span></p></li>')}else{f=a.Node.create('<li class="msg-more-icon">'+e+"</li>");if(!this.msgOrder){b=this.reversePivot}}d=this.nodes.item(b);d.addClass("card-border-bottom card-height");d.insert(f,"after")};a.Groups.TopicBase.prototype._conversationClickHandler=function(c){var b=this.node.one(".yg-msg-reply-container");if(b){b.remove()}this.showReplyBox(c);this.scrollToContent();this.alignReplyBoxToBottom();GROUPS.PAGE._dockNode()};a.Groups.TopicBase.prototype.showReplyBox=function(j,d){var n,m,g,p,b,q,o,k,i,f=null,c="",h="",l,r;this.inReplyToHeaderValue="";q=this.compiledRcptList;q=q({emailDomain:GROUPS.EMAIL_DOMAIN});q=a.Node.create(q);if(a.one(".reply-all-btn")){a.one(".reply-all-btn").addClass("btn-disabled")}if(d!=null){b=d;this.replyBox=b.one(".reply-box");o=j.currentTarget.ancestor(".yg-msg-read-container")||j.currentTarget.ancestor(".yg-thread-container");r=(o.one(".msg-content-raw")||o.one(".msg-content"));f=r.getHTML();i=o.getData("uid");k=o.getData("email");l=o.getData("sender-status");b.setAttribute("data-uid",i);b.setAttribute("data-sender-status",l);this.inReplyToHeaderValue=o.getData("reply-to-header");this.contentTransformed=o.getData("content-transformed")}else{this.replyBox=this.node.one(".reply-box");this.replyBox.removeClass("conv-box-container");this.replyBox.one(".conv-box").addClass("hide");b=this.node;r=this.nodes.item(this.nodesNumber-1);r=r.one(".msg-content-raw")||r.one(".msg-content");f=r.getHTML();k=this.nodes.item(this.nodesNumber-1).getData("email");i=this.nodes.item(this.nodesNumber-1).getData("uid");l=this.nodes.item(this.nodesNumber-1).getData("sender-status");this.replyBox.setAttribute("data-uid",i);this.replyBox.setAttribute("data-sender-status",l);this.inReplyToHeaderValue=this.nodes.item(this.nodesNumber-1).getData("reply-to-header");this.contentTransformed=this.nodes.item(this.nodesNumber-1).getData("content-transformed")}this.setRecipients(k,i,q);this.replyBox.removeClass("maximized");if(f){c="<br><br>---"+GROUPS.YRB_STRINGS.STR_WROTE.replace("{defaultEmail}",this.defaultEmail).replace("{email}","&lt;"+k+"&gt;")+"<br><br>";f=c+f;this.qrString=c}j.rapidNode="yg-iframe-container";this.conv.messageReplyHandler(j,"reply-all",b,f);n=this.replyBox.one(".link-attachment-container");this.conv.resetReplyBox();rcpt=this.replyBox.one(".recipient");rcpt.setHTML(q);rcpt=a.Escape.html(this.replyBox.one(".selected-mailto span").getHTML());this.replyBox.one(".feedback-area").removeClass("error");this.replyBox.one(".topic-send").removeClass("hide");this.replyBox.one(".topic-cancel").removeClass("hide");this.renderRecipients();this.conv.showReplyToInfo(false);if(j.currentTarget.get("tagName")!="A"){GROUPS.INSTR.beaconClick("yg-iframe-container","topic-reply-click",2,false)}GROUPS.UTILS.fireYGBeacon({action:"Topic Reply",pv:1});GROUPS.INSTR.firePageBeacon("topic-reply")};a.Groups.TopicBase.prototype.setRecipients=function(j,g,d){var h,b,e=d.one(".selected-mailto span"),i,k="",f=j,i=d.one(".mailto-menu ul"),c="LIST";e.setHTML(this.defaultEmail);if(j.toLowerCase()!=this.owner&&j.toLowerCase()!=this.defaultEmail.toLowerCase()){c=this.replyTo;k='<li class="options" data-reply-to="LIST_AND_SENDER"><span>'+j+", "+this.defaultEmail+"</span></li>";if(this.isMember!="1"||this.replyTo=="SENDER"||this.replyTo=="USERS"||this.replyTo=="UNSUBSCRIBE"){i.insert(k,2);k='<li class="options" data-reply-to="SENDER"><span>'+j+"</span></li>";i.insert(k,1);c="SENDER"}else{if(this.replyTo=="OWNER"){i.insert(k,2);k='<li class="options" data-reply-to="OWNER"><span>'+this.owner+"</span></li>";i.all("li").item(2).remove();i.insert(k,1);k='<li class="options" data-reply-to="SENDER"><span>'+j+"</span></li>";i.insert(k,3);j=this.owner}else{if(this.replyTo=="LIST_AND_SENDER"){i.insert(k,1);k='<li class="options" data-reply-to="SENDER"><span>'+j+"</span></li>";i.insert(k,3);j=j+", "+this.defaultEmail}else{i.insert(k,2);k='<li class="options" data-reply-to="SENDER"><span>'+j+"</span></li>";i.insert(k,2);j=this.defaultEmail}}}k='<li class="options" data-reply-to="OWNER_AND_SENDER"><span>'+f+", "+this.owner+"</span></li>";i.insert(k)}else{if(this.isMember!="1"){k='<li class="options" data-reply-to="OWNER"><span>'+this.owner+"</span></li>";i.all("li").item(1).remove();i.insert(k,1);j=this.owner;c="OWNER"}else{j=this.defaultEmail}}e.setHTML(j);d.one(".selected-mailto").setAttribute("data-reply-to",c)};a.Groups.TopicBase.prototype.renderRecipients=function(){if(!this.replyBox.one(".selected-mailto").hasClass("rcpt-overlay")){var b,d=this.replyBox.one(".recipient"),c;this.conv.initMailFromOlay(this.replyBox.one(".selected-mailto"),this.replyBox.one(".mailto-menu"));b=d.one(".selected-mailto").get("offsetWidth");d.one("ul").setStyle("width",(b-3)+"px");this.replyBox.one(".selected-mailto").addClass("rcpt-overlay")}if(GROUPS.PAGE._isMobile){GROUPS.UTILS.showComposeHeader(this.replyBox)}};a.Groups.TopicBase.prototype.getOffsetTop=function(c){var b=0;do{b+=c.get("offsetTop")}while(c=c.get("offsetParent"));return b};a.Groups.TopicBase.prototype.scrollToContent=function(){var b=this.getOffsetTop(this.replyBox);b=b-this._dockedHeight;this.currentY=b;if(b<=0){return}window.scrollTo(0,b)};a.Groups.TopicBase.prototype.alignReplyBoxToBottom=function(){if(this.currentY<=0){return}var d,b,c=a.one("body").get("winHeight");b=this.replyBox.get("offsetHeight");d=this.currentY-(c-b-this._dockedHeight-10);if(d<0){d=0}window.scrollTo(0,d)};a.Groups.TopicBase.prototype.getMsgStatus=function(b){if(!b){this.replyBox.one(".feedback-area").addClass("error")}else{var d=this.node.one(".msg-response");if(a.one(".reply-all-btn")){a.one(".reply-all-btn").removeClass("btn-disabled")}GROUPS.UTILS.notifyScreenReader(d.getHTML());if(this.replyBox.hasClass("reply-link")){var c=this.replyBox.ancestor(".yg-msg-reply-container");d=a.Node.create('<p class="inline-response fc-gray">'+d.getHTML()+"</p>");c.setHTML(d)}else{this.replyBox.addClass("conv-box-container");this.replyBox.one(".conv-box").removeClass("hide");d.removeClass("hide");d.setStyle("opacity",1)}a.later(5000,a,function(){GROUPS.UTILS.handleTransition(d,function(){if(c){c.remove()}else{d.addClass("hide")}})})}};a.Groups.TopicBase.prototype._msgSendHandler=function(c){this.replyBox.one(".feedback-area").removeClass("err");this.conv.messageSendHandler(c,this.getMsgStatus,this);var b=this.conv.newMessageRTEArray[0];if(b&&(!b.enhancrSupported||!b._linksCount)){if(this.get("subtype")=="post"){GROUPS.INSTR.beaconClick("yg-iframe-container","post-reply-send",1,false)}else{GROUPS.INSTR.beaconClick("yg-iframe-container","topic-reply-send",1,false)}}GROUPS.PAGE.showAds(true,false)};a.Groups.TopicBase.prototype._msgCancelHandler=function(c){var b=c.currentTarget;this.conv.replyCancelHandler(c);if(this.node.one(".reply-all-btn")){this.node.one(".reply-all-btn").removeClass("btn-disabled")}if(this.replyBox.hasClass("reply-link")){b.ancestor(".yg-msg-reply-container").remove(true)}else{this.replyBox.addClass("conv-box-container");this.replyBox.one(".conv-box").removeClass("hide")}this.replyBox.one(".collapse-header").addClass("hide");this.replyBox.one("#expand-header").removeClass("hide");window.scrollTo(0,GROUPS.PAGE.dockPos);GROUPS.PAGE._dockNode();this.updateFoldBttn();if(this.get("subtype")=="post"){GROUPS.INSTR.beaconClick("yg-iframe-container","post-reply-cancel",1,false)}else{GROUPS.INSTR.beaconClick("yg-iframe-container","topic-reply-cancel",2,false)}};a.Groups.TopicBase.prototype.updateFoldBttn=function(){if(!this.viewMenu){return}if(GROUPS.ACTIONBAR.viewOverlay){this.viewMenu=GROUPS.ACTIONBAR.viewOverlay.get("contentBox")}var b=this.nodesNumber,d=this.viewMenu.one(".yg-topic-fold");for(var c=0;c<b;c++){if(!this.nodes.item(c).hasClass("card")){this.topicFolded=true;d.removeClass("yg-topic-unfold");d.setHTML(GROUPS.YRB_STRINGS.NAV_EXPAND);return}}this.topicFolded=false;d.addClass("yg-topic-unfold");d.setHTML(GROUPS.YRB_STRINGS.NAV_COLLAPSE);GROUPS.PAGE.hideTooltip()}});